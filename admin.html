<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ADMIN | E-D√©chets CI üá®üáÆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Syne:wght@800;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --rouge: #c0392b;
            --vert: #0d4a1f;
            --vert-light: #1b7a35;
            --bleu: #1565c0;
            --orange: #e65c00;
            --violet: #6a1b9a;
            --dark: #0f1923;
            --card-bg: #1a2535;
            --text-light: rgba(255,255,255,0.9);
            --text-muted: rgba(255,255,255,0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--dark);
            color: var(--text-light);
            min-height: 100vh;
        }

        /* === HEADER === */
        header {
            background: linear-gradient(135deg, #1a0a0a 0%, var(--rouge) 100%);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 20px rgba(0,0,0,0.4);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left h1 {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .header-left p {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 1px;
        }

        .admin-badge {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px; height: 8px;
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.8); }
        }

        /* === STATS GRID === */
        .stats-section {
            padding: 16px;
            background: #111c2a;
        }

        .stats-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.06);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
        }

        .stat-card.total::before { background: linear-gradient(90deg, #4facfe, #00f2fe); }
        .stat-card.info::before { background: linear-gradient(90deg, var(--bleu), #42a5f5); }
        .stat-card.batt::before { background: linear-gradient(90deg, var(--orange), #ffcc80); }
        .stat-card.elec::before { background: linear-gradient(90deg, var(--violet), #ce93d8); }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-family: 'Syne', sans-serif;
            font-size: 42px;
            font-weight: 800;
            line-height: 1;
            margin: 6px 0 4px;
            transition: all 0.5s ease;
        }

        .stat-card.total .stat-number { color: #4facfe; }
        .stat-card.info .stat-number { color: #64b5f6; }
        .stat-card.batt .stat-number { color: #ffb74d; }
        .stat-card.elec .stat-number { color: #ce93d8; }

        .stat-sub {
            font-size: 10px;
            color: var(--text-muted);
        }

        .stat-icon {
            position: absolute;
            right: 14px;
            top: 14px;
            font-size: 22px;
            opacity: 0.3;
        }

        /* === RECENT ALERTS === */
        .alerts-section {
            padding: 0 16px 12px;
            background: #111c2a;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .new-badge {
            background: var(--rouge);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            display: none;
        }

        .new-badge.show { display: block; }

        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 120px;
            overflow-y: auto;
        }

        .alert-item {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255,255,255,0.06);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .alert-dot.info { background: #64b5f6; }
        .alert-dot.batt { background: #ffb74d; }
        .alert-dot.elec { background: #ce93d8; }

        .alert-info { flex: 1; min-width: 0; }
        .alert-type { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .alert-meta { font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .alert-time { font-size: 10px; color: var(--text-muted); flex-shrink: 0; }

        /* === MAP === */
        #map-wrapper {
            position: relative;
        }

        #map { height: 45vh; width: 100%; }

        .map-overlay-btns {
            position: absolute;
            top: 10px; right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-btn {
            background: white;
            border: none;
            border-radius: 8px;
            width: 36px; height: 36px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .map-counter {
            position: absolute;
            bottom: 12px; left: 12px;
            z-index: 1000;
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }

        /* === POPUP ADMIN === */
        .admin-popup { font-family: 'Space Grotesk', sans-serif; }
        .admin-popup img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }
        .popup-type { font-weight: 700; font-size: 13px; color: #1b5e20; }
        .popup-meta { font-size: 11px; color: #555; margin: 4px 0; line-height: 1.5; }

        .btn-nav {
            display: block;
            background: #1b5e20;
            color: white !important;
            text-decoration: none;
            padding: 9px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
            margin-bottom: 6px;
        }

        .btn-email {
            display: block;
            background: #1565c0;
            color: white !important;
            padding: 8px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
            margin-bottom: 6px;
            border: none;
            width: 100%;
            cursor: pointer;
        }

        .btn-delete {
            display: block;
            background: white;
            color: #c0392b !important;
            padding: 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            border: 1.5px solid #c0392b;
            cursor: pointer;
            width: 100%;
        }

        /* === TOAST === */
        .toast {
            display: none;
            position: fixed;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background: #1b5e20;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            z-index: 99999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .toast.show { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* === MODAL EMAIL === */
        .email-modal-overlay {
            display: none;
            position: fixed;
            z-index: 50000;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }
        .email-modal-overlay.show { display: flex; }

        .email-modal {
            background: #1a2535;
            border-radius: 18px;
            padding: 24px;
            width: 90%;
            max-width: 380px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .email-modal h3 {
            font-family: 'Syne', sans-serif;
            color: #64b5f6;
            margin-bottom: 16px;
        }

        .email-modal textarea {
            width: 100%;
            padding: 12px;
            border: 1.5px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            background: rgba(255,255,255,0.08);
            color: white;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 10px;
        }

        .email-modal-btns { display: flex; gap: 10px; }

        .btn-send-email {
            flex: 1;
            background: #1565c0;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            cursor: pointer;
        }

        .btn-cancel-email {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-family: 'Space Grotesk', sans-serif;
            cursor: pointer;
        }

        /* Leaflet popup customization */
        .leaflet-popup-content-wrapper { border-radius: 12px !important; padding: 0 !important; overflow: hidden; }
        .leaflet-popup-content { margin: 12px 14px !important; width: 180px !important; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>‚öôÔ∏è ADMIN DASHBOARD</h1>
        <p>E-D√©chets CI üá®üáÆ ‚Äî Gestion des collectes</p>
    </div>
    <div class="admin-badge">
        <div class="status-dot"></div>
        LIVE
    </div>
</header>

<div class="stats-section">
    <div class="stats-title">üìä Statistiques en temps r√©el</div>
    <div class="stats-grid">
        <div class="stat-card total">
            <span class="stat-icon">üóÇÔ∏è</span>
            <div class="stat-label">Total signalements</div>
            <div class="stat-number" id="s-all">0</div>
            <div class="stat-sub">en attente de collecte</div>
        </div>
        <div class="stat-card info">
            <span class="stat-icon">üíª</span>
            <div class="stat-label">Informatique</div>
            <div class="stat-number" id="s-info">0</div>
            <div class="stat-sub">PC / Mobile / Tablette</div>
        </div>
        <div class="stat-card batt">
            <span class="stat-icon">üîã</span>
            <div class="stat-label">Batteries</div>
            <div class="stat-number" id="s-batt">0</div>
            <div class="stat-sub">Piles / Accus</div>
        </div>
        <div class="stat-card elec">
            <span class="stat-icon">üì∫</span>
            <div class="stat-label">√âlectrom√©nager</div>
            <div class="stat-number" id="s-elec">0</div>
            <div class="stat-sub">Frigo / TV / Micro-ondes</div>
        </div>
    </div>
</div>

<div class="alerts-section">
    <div class="section-header">
        <div class="section-title">üîî Signalements r√©cents</div>
        <div class="new-badge" id="new-badge">NOUVEAU</div>
    </div>
    <div class="alerts-list" id="alerts-list"></div>
</div>

<div id="map-wrapper">
    <div id="map"></div>
    <div class="map-overlay-btns">
        <button class="map-btn" onclick="resetMapView()" title="Recentrer">üéØ</button>
    </div>
    <div class="map-counter" id="map-counter">0 points</div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- MODAL EMAIL PERSONNALIS√â -->
<div class="email-modal-overlay" id="email-modal">
    <div class="email-modal">
        <h3>üìß Envoyer un message</h3>
        <p style="font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:12px;" id="email-modal-to"></p>
        <textarea id="email-body" placeholder="Votre signalement a bien √©t√© pris en compte. Notre √©quipe viendra collecter le d√©chet prochainement. Merci pour votre engagement ! üá®üáÆ"></textarea>
        <div class="email-modal-btns">
            <button class="btn-send-email" id="btn-confirm-send">üì§ Envoyer</button>
            <button class="btn-cancel-email" onclick="closeEmailModal()">Annuler</button>
        </div>
    </div>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getFirestore, collection, onSnapshot,
        doc, deleteDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // =============================================
    // CONFIGURATION ‚Äî M√äMES VALEURS QUE PUBLIC.HTML
    // =============================================
    const firebaseConfig = {
        apiKey: "AIzaSyCx78sbB4rxfF24tzooTUWPrZcOOGWDL8xk",
        authDomain: "e-dechets-ci.firebaseapp.com",
        projectId: "e-dechets-ci",
        appId: "1:921449360134:web:db17f6d1f285ecddfa8c87"
    };

    const EMAILJS_PUBLIC_KEY  = "VOTRE_PUBLIC_KEY";
    const EMAILJS_SERVICE_ID  = "VOTRE_SERVICE_ID";
    const EMAILJS_TEMPLATE_ID_COLLECTE = "VOTRE_TEMPLATE_COLLECTE_ID"; // Template pour "collect√©"
    const EMAILJS_TEMPLATE_ID_CUSTOM   = "VOTRE_TEMPLATE_CUSTOM_ID";   // Template pour message libre
    // =============================================

    emailjs.init(EMAILJS_PUBLIC_KEY);

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "points_collecte");

    // === CARTE ===
    const map = L.map('map', { zoomControl: false }).setView([5.3484, -4.0305], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    window.resetMapView = () => map.setView([5.3484, -4.0305], 11);

    // === UTILITAIRES ===
    function showToast(msg, duration = 4000) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }

    function getTypeColor(type) {
        const t = (type || '').toLowerCase();
        if (t.includes('info') || t.includes('mobile')) return '#64b5f6';
        if (t.includes('batt') || t.includes('pile')) return '#ffb74d';
        return '#ce93d8';
    }

    function getTypeClass(type) {
        const t = (type || '').toLowerCase();
        if (t.includes('info')) return 'info';
        if (t.includes('batt')) return 'batt';
        return 'elec';
    }

    function timeAgo(timestamp) {
        if (!timestamp) return '';
        const now = Date.now();
        const diff = now - timestamp.toMillis();
        const min = Math.floor(diff / 60000);
        if (min < 1) return '√Ä l\'instant';
        if (min < 60) return `il y a ${min} min`;
        const h = Math.floor(min / 60);
        if (h < 24) return `il y a ${h}h`;
        return `il y a ${Math.floor(h / 24)}j`;
    }

    // === SUPPRESSION ===
    window.supprimerDechet = async (id, email, type) => {
        if (!confirm("Confirmer la collecte de ce d√©chet ? Un email de notification sera envoy√© au d√©clarant.")) return;

        try {
            // Envoyer email de collecte
            if (email && EMAILJS_SERVICE_ID !== "VOTRE_SERVICE_ID") {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_COLLECTE, {
                    to_email: email,
                    to_name: email.split('@')[0],
                    type_dechet: type
                });
            }

            await deleteDoc(doc(db, "points_collecte", id));
            showToast("‚úÖ D√©chet marqu√© comme collect√©" + (email ? " | Email envoy√©" : ""));
        } catch (err) {
            console.error(err);
            showToast("‚ùå Erreur lors de la suppression");
        }
    };

    // === EMAIL MODAL ===
    let currentEmailTarget = null;

    window.openEmailModal = (email, id) => {
        currentEmailTarget = { email, id };
        document.getElementById('email-modal-to').innerText = `√Ä : ${email}`;
        document.getElementById('email-body').value = "";
        document.getElementById('email-modal').classList.add('show');
    };

    window.closeEmailModal = () => {
        document.getElementById('email-modal').classList.remove('show');
        currentEmailTarget = null;
    };

    document.getElementById('btn-confirm-send').onclick = async () => {
        if (!currentEmailTarget) return;
        const message = document.getElementById('email-body').value.trim();
        if (!message) { showToast("‚ö†Ô∏è Message vide"); return; }

        const btn = document.getElementById('btn-confirm-send');
        btn.disabled = true;
        btn.innerText = '‚è≥ Envoi...';

        try {
            if (EMAILJS_SERVICE_ID !== "VOTRE_SERVICE_ID") {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_CUSTOM, {
                    to_email: currentEmailTarget.email,
                    to_name: currentEmailTarget.email.split('@')[0],
                    message: message
                });
                showToast(`üìß Email envoy√© √† ${currentEmailTarget.email}`);
            } else {
                showToast("‚ö†Ô∏è EmailJS non configur√© - voir console");
                console.log("Email simul√© vers :", currentEmailTarget.email, "\nMessage :", message);
            }
        } catch (err) {
            showToast("‚ùå Erreur d'envoi email");
            console.error(err);
        }

        btn.disabled = false;
        btn.innerText = 'üì§ Envoyer';
        closeEmailModal();
    };

    // === SNAPSHOT TEMPS R√âEL ===
    let prevCount = 0;
    const alertsData = [];

    const q = query(colRef, orderBy("date", "desc"));

    onSnapshot(q, (snap) => {
        const count = { all: 0, info: 0, batt: 0, elec: 0 };

        // Supprimer les marqueurs existants
        map.eachLayer((layer) => {
            if (layer instanceof L.Marker) map.removeLayer(layer);
        });

        alertsData.length = 0;

        snap.forEach((docDb) => {
            const d = docDb.data();
            const id = docDb.id;
            const typeLower = (d.type || "").toLowerCase();

            count.all++;
            if (typeLower.includes("info"))  count.info++;
            else if (typeLower.includes("batt")) count.batt++;
            else count.elec++;

            if (!d.lat || !d.lng) return;

            const color = getTypeColor(d.type);

            const icon = L.divIcon({
                html: `<div style="
                    background: ${color};
                    width: 18px; height: 18px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
                    position: relative;
                "><div style="
                    position: absolute;
                    bottom: -6px; left: 50%;
                    transform: translateX(-50%);
                    width: 0; height: 0;
                    border-left: 4px solid transparent;
                    border-right: 4px solid transparent;
                    border-top: 6px solid ${color};
                "></div></div>`,
                className: '',
                iconSize: [24, 28],
                iconAnchor: [12, 28]
            });

            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lng}`;
            const dateStr = d.date ? timeAgo(d.date) : '';

            L.marker([d.lat, d.lng], { icon }).addTo(map).bindPopup(`
                <div class="admin-popup" style="width:185px">
                    ${d.photo ? `<img src="${d.photo}" alt="Photo d√©chet">` : ''}
                    <div class="popup-type">${d.type || 'D√©chet'}</div>
                    <div class="popup-meta">
                        üìß ${d.email || '‚Äî'}<br>
                        üìç ${d.nom || '‚Äî'}<br>
                        üïê ${dateStr}
                    </div>
                    <a href="${navUrl}" target="_blank" class="btn-nav">üöÄ ITIN√âRAIRE GPS</a>
                    <button onclick="openEmailModal('${d.email}', '${id}')" class="btn-email">üìß CONTACTER</button>
                    <button onclick="supprimerDechet('${id}', '${d.email}', '${d.type}')" class="btn-delete">‚úÖ MARQUER COLLECT√â</button>
                </div>
            `);

            alertsData.push({
                type: d.type,
                nom: d.nom,
                email: d.email,
                date: d.date
            });
        });

        // Mettre √† jour les stats avec animation
        function animateNumber(elementId, target) {
            const el = document.getElementById(elementId);
            const current = parseInt(el.innerText) || 0;
            if (current === target) return;
            const step = target > current ? 1 : -1;
            const interval = setInterval(() => {
                const now = parseInt(el.innerText) || 0;
                if (now === target) { clearInterval(interval); return; }
                el.innerText = now + step;
            }, 50);
        }

        animateNumber('s-all', count.all);
        animateNumber('s-info', count.info);
        animateNumber('s-batt', count.batt);
        animateNumber('s-elec', count.elec);

        document.getElementById('map-counter').innerText = `${count.all} point${count.all > 1 ? 's' : ''}`;

        // Notification nouveau signalement
        if (count.all > prevCount && prevCount > 0) {
            document.getElementById('new-badge').classList.add('show');
            showToast("üîî Nouveau signalement re√ßu !");
            setTimeout(() => document.getElementById('new-badge').classList.remove('show'), 5000);
        }
        prevCount = count.all;

        // Mettre √† jour la liste des alertes r√©centes (max 5)
        const alertsList = document.getElementById('alerts-list');
        alertsList.innerHTML = '';
        alertsData.slice(0, 5).forEach(a => {
            const item = document.createElement('div');
            item.className = 'alert-item';
            item.innerHTML = `
                <div class="alert-dot ${getTypeClass(a.type)}"></div>
                <div class="alert-info">
                    <div class="alert-type">${a.type || 'D√©chet'} ‚Äî ${a.nom || 'Sans nom'}</div>
                    <div class="alert-meta">üìß ${a.email || '‚Äî'}</div>
                </div>
                <div class="alert-time">${a.date ? timeAgo(a.date) : ''}</div>
            `;
            alertsList.appendChild(item);
        });

        if (alertsData.length === 0) {
            alertsList.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.3); font-size:12px; padding:16px;">Aucun signalement pour le moment</div>';
        }
    });
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
