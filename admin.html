<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ADMIN | E-D√©chets CI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --rouge: #d32f2f; --vert: #1b5e20; --bleu: #1976d2; --orange: #ff9800; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; }
        header { background: var(--rouge); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; background: #fff; }
        .card { padding: 15px; border-radius: 12px; text-align: center; color: white; }
        .bg-total { background: #2c3e50; } .bg-info { background: var(--bleu); } .bg-batt { background: var(--orange); } .bg-elec { background: #8e44ad; }
        .card span { display: block; font-size: 28px; font-weight: 900; }
        #map { height: 65vh; width: 100%; border-top: 2px solid #ddd; }
        .admin-popup { text-align: center; font-size: 13px; }
        .admin-popup img { width: 100%; border-radius: 8px; margin-bottom: 8px; }
        .btn-nav { display: block; background: var(--vert); color: white !important; padding: 10px; text-decoration: none; border-radius: 6px; font-weight: bold; margin-bottom: 8px; }
        .btn-delete { display: block; background: #fff; color: #d32f2f !important; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: bold; border: 1px solid #d32f2f; cursor: pointer; width: 100%; }
    </style>
</head>
<body>
<header>ADMIN : GESTION DES COLLECTES üá®üáÆ</header>
<div class="stats-grid">
    <div class="card bg-total"><small>Total</small><span id="s-all">0</span></div>
    <div class="card bg-info"><small>Informatique</small><span id="s-info">0</span></div>
    <div class="card bg-batt"><small>Batteries</small><span id="s-batt">0</span></div>
    <div class="card bg-elec"><small>√âlectro</small><span id="s-elec">0</span></div>
</div>
<div id="map"></div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCx78sbB4rxfF24tzooTUWPrZcOOGWDL8xk",
        authDomain: "e-dechets-ci.firebaseapp.com",
        projectId: "e-dechets-ci",
        appId: "1:921449360134:web:db17f6d1f285ecddfa8c87"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "points_collecte");

    var map = L.map('map').setView([5.3484, -4.0305], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    window.supprimerDechet = async (id) => {
        if(confirm("Confirmer la collecte ?")) { await deleteDoc(doc(db, "points_collecte", id)); }
    };

    onSnapshot(colRef, (snap) => {
        let count = { all: 0, info: 0, batt: 0, elec: 0 };
        map.eachLayer((layer) => { if (layer instanceof L.Marker) map.removeLayer(layer); });

        snap.forEach((docDb) => {
            const d = docDb.data();
            const id = docDb.id;
            const typeLower = (d.type || "").toLowerCase();
            count.all++;
            if (typeLower.includes("info")) count.info++;
            else if (typeLower.includes("batt")) count.batt++;
            else if (typeLower.includes("elec")) count.elec++;

            const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${d.lat},${d.lng}`;
            
            L.marker([d.lat, d.lng]).addTo(map).bindPopup(`
                <div class="admin-popup" style="width:180px">
                    <img src="${d.photo}">
                    <strong>${d.type}</strong><br>
                    <small>üìß ${d.email}</small><br>
                    <small>üìç ${d.nom}</small><br><br>
                    <a href="${navUrl}" target="_blank" class="btn-nav">üöÄ Y ALLER</a>
                    <button onclick="supprimerDechet('${id}')" class="btn-delete">‚úÖ COLLECT√â</button>
                </div>
            `);
        });
        document.getElementById('s-all').innerText = count.all;
        document.getElementById('s-info').innerText = count.info;
        document.getElementById('s-batt').innerText = count.batt;
        document.getElementById('s-elec').innerText = count.elec;
    });
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
